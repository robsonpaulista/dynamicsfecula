generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String            @id @default(uuid())
  name                    String
  email                   String            @unique
  passwordHash            String            @map("password_hash")
  role                    UserRole          @default(ESTOQUE)
  isActive                Boolean           @default(true) @map("is_active")
  createdAt               DateTime          @default(now()) @map("created_at")
  updatedAt               DateTime          @updatedAt @map("updated_at")
  createdAuditLogs        AuditLog[]
  createdCashTransactions CashTransaction[]
  createdPurchases        PurchaseOrder[]   @relation("PurchaseCreatedBy")
  createdReceipts         PurchaseReceipt[]
  createdSales            SalesOrder[]      @relation("SalesCreatedBy")
  createdStockMovements   StockMovement[]

  @@map("users")
}

model Supplier {
  id              String            @id @default(uuid())
  name            String
  document        String?
  phone           String?
  email           String?
  addressJson     Json?             @map("address_json")
  isActive        Boolean           @default(true) @map("is_active")
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  accountsPayable AccountsPayable[]
  purchaseOrders  PurchaseOrder[]

  @@map("suppliers")
}

model Customer {
  id                 String               @id @default(uuid())
  name               String
  document           String?
  phone              String?
  email              String?
  addressJson        Json?                @map("address_json")
  isActive           Boolean              @default(true) @map("is_active")
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  accountsReceivable AccountsReceivable[]
  salesOrders        SalesOrder[]

  @@map("customers")
}

model Product {
  id             String          @id @default(uuid())
  sku            String          @unique
  name           String
  type           ProductType     @default(MP)
  unit           String
  minStock       Decimal?        @default(0) @map("min_stock") @db.Decimal(10, 2)
  costPrice      Decimal?        @default(0) @map("cost_price") @db.Decimal(10, 2)
  salePrice      Decimal?        @default(0) @map("sale_price") @db.Decimal(10, 2)
  isActive       Boolean         @default(true) @map("is_active")
  createdAt      DateTime        @default(now()) @map("created_at")
  updatedAt      DateTime        @updatedAt @map("updated_at")
  purchaseItems  PurchaseItem[]
  salesItems     SalesItem[]
  stockBalance   StockBalance?
  stockMovements StockMovement[]

  @@map("products")
}

model StockBalance {
  id        String   @id @default(uuid())
  productId String   @unique @map("product_id")
  quantity  Decimal  @db.Decimal(10, 2)
  updatedAt DateTime @updatedAt @map("updated_at")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("stock_balances")
}

model StockMovement {
  id            String            @id @default(uuid())
  productId     String            @map("product_id")
  type          StockMovementType
  quantity      Decimal           @db.Decimal(10, 2)
  unitCost      Decimal?          @map("unit_cost") @db.Decimal(10, 2)
  referenceType ReferenceType?    @map("reference_type")
  referenceId   String?           @map("reference_id")
  note          String?
  createdById   String            @map("created_by")
  createdAt     DateTime          @default(now()) @map("created_at")
  createdBy     User              @relation(fields: [createdById], references: [id])
  product       Product           @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([createdAt])
  @@map("stock_movements")
}

model PurchaseOrder {
  id              String              @id @default(uuid())
  supplierId      String              @map("supplier_id")
  status          PurchaseOrderStatus @default(DRAFT)
  issueDate       DateTime            @map("issue_date")
  total           Decimal             @default(0) @db.Decimal(10, 2)
  notes           String?
  createdById     String              @map("created_by")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  accountsPayable AccountsPayable[]
  items           PurchaseItem[]
  createdBy       User                @relation("PurchaseCreatedBy", fields: [createdById], references: [id])
  supplier        Supplier            @relation(fields: [supplierId], references: [id])
  receipts        PurchaseReceipt[]

  @@index([supplierId])
  @@index([status])
  @@map("purchase_orders")
}

model PurchaseItem {
  id              String        @id @default(uuid())
  purchaseOrderId String        @map("purchase_order_id")
  productId       String        @map("product_id")
  quantity        Decimal       @db.Decimal(10, 2)
  unitPrice       Decimal       @map("unit_price") @db.Decimal(10, 2)
  total           Decimal       @default(0) @db.Decimal(10, 2)
  product         Product       @relation(fields: [productId], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@index([purchaseOrderId])
  @@map("purchase_items")
}

model PurchaseReceipt {
  id              String        @id @default(uuid())
  purchaseOrderId String        @map("purchase_order_id")
  receiptDate     DateTime      @map("receipt_date")
  invoiceNumber   String?       @map("invoice_number")
  total           Decimal       @default(0) @db.Decimal(10, 2)
  createdById     String        @map("created_by")
  createdAt       DateTime      @default(now()) @map("created_at")
  createdBy       User          @relation(fields: [createdById], references: [id])
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  @@index([purchaseOrderId])
  @@map("purchase_receipts")
}

model SalesOrder {
  id                 String               @id @default(uuid())
  customerId         String               @map("customer_id")
  status             SalesOrderStatus     @default(DRAFT)
  saleDate           DateTime             @map("sale_date")
  total              Decimal              @default(0) @db.Decimal(10, 2)
  createdById        String               @map("created_by")
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  accountsReceivable AccountsReceivable[]
  items              SalesItem[]
  createdBy          User                 @relation("SalesCreatedBy", fields: [createdById], references: [id])
  customer           Customer             @relation(fields: [customerId], references: [id])

  @@index([customerId])
  @@index([status])
  @@map("sales_orders")
}

model SalesItem {
  id           String     @id @default(uuid())
  salesOrderId String     @map("sales_order_id")
  productId    String     @map("product_id")
  quantity     Decimal    @db.Decimal(10, 2)
  unitPrice    Decimal    @map("unit_price") @db.Decimal(10, 2)
  total        Decimal    @default(0) @db.Decimal(10, 2)
  product      Product    @relation(fields: [productId], references: [id])
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)

  @@index([salesOrderId])
  @@map("sales_items")
}

model Category {
  id                 String               @id @default(uuid())
  name               String
  kind               CategoryKind
  accountsPayable    AccountsPayable[]
  accountsReceivable AccountsReceivable[]
  cashTransactions   CashTransaction[]

  @@map("categories")
}

model PaymentMethod {
  id                 String               @id @default(uuid())
  name               String
  accountsPayable    AccountsPayable[]
  accountsReceivable AccountsReceivable[]

  @@map("payment_methods")
}

model AccountsPayable {
  id              String         @id @default(uuid())
  supplierId      String?        @map("supplier_id")
  purchaseOrderId String?        @map("purchase_order_id")
  description     String
  categoryId      String?        @map("category_id")
  dueDate         DateTime       @map("due_date")
  amount          Decimal        @db.Decimal(10, 2)
  status          AccountStatus  @default(OPEN)
  paidAt          DateTime?      @map("paid_at")
  paymentMethodId String?        @map("payment_method_id")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  category        Category?      @relation(fields: [categoryId], references: [id])
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  supplier        Supplier?      @relation(fields: [supplierId], references: [id])
  paymentSources  PaymentSource[]

  @@index([status])
  @@index([dueDate])
  @@map("accounts_payable")
}

model PaymentSource {
  id              String          @id @default(uuid())
  accountsPayableId String        @map("accounts_payable_id")
  name            String
  amount          Decimal         @db.Decimal(10, 2)
  createdAt       DateTime        @default(now()) @map("created_at")
  accountsPayable AccountsPayable @relation(fields: [accountsPayableId], references: [id], onDelete: Cascade)

  @@index([accountsPayableId])
  @@map("payment_sources")
}

model AccountsReceivable {
  id              String         @id @default(uuid())
  customerId      String?        @map("customer_id")
  salesOrderId    String?        @map("sales_order_id")
  description     String
  categoryId      String?        @map("category_id")
  dueDate         DateTime       @map("due_date")
  amount          Decimal        @db.Decimal(10, 2)
  status          AccountStatus  @default(OPEN)
  receivedAt      DateTime?      @map("received_at")
  paymentMethodId String?        @map("payment_method_id")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  category        Category?      @relation(fields: [categoryId], references: [id])
  customer        Customer?      @relation(fields: [customerId], references: [id])
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  salesOrder      SalesOrder?    @relation(fields: [salesOrderId], references: [id])

  @@index([status])
  @@index([dueDate])
  @@map("accounts_receivable")
}

model CashTransaction {
  id          String                @id @default(uuid())
  type        CashTransactionType
  origin      CashTransactionOrigin
  originId    String?               @map("origin_id")
  date        DateTime
  amount      Decimal               @db.Decimal(10, 2)
  description String
  categoryId  String?               @map("category_id")
  createdById String                @map("created_by")
  createdAt   DateTime              @default(now()) @map("created_at")
  category    Category?             @relation(fields: [categoryId], references: [id])
  createdBy   User                  @relation(fields: [createdById], references: [id])

  @@index([date])
  @@index([type])
  @@map("cash_transactions")
}

model AuditLog {
  id           String      @id @default(uuid())
  userId       String      @map("user_id")
  action       AuditAction
  entity       String
  entityId     String?     @map("entity_id")
  metadataJson Json?       @map("metadata_json")
  createdAt    DateTime    @default(now()) @map("created_at")
  user         User        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

enum UserRole {
  ADMIN
  FINANCEIRO
  COMPRAS
  VENDAS
  ESTOQUE
}

enum ProductType {
  MP
  PA
  SERVICO
}

enum PurchaseOrderStatus {
  DRAFT
  APPROVED
  RECEIVED
  CANCELED
}

enum SalesOrderStatus {
  DRAFT
  CONFIRMED
  DELIVERED
  CANCELED
}

enum StockMovementType {
  IN
  OUT
  ADJUST
}

enum ReferenceType {
  PURCHASE
  SALE
  INVENTORY
  MANUAL
}

enum AccountStatus {
  OPEN
  PAID
  RECEIVED
  CANCELED
}

enum CashTransactionType {
  IN
  OUT
}

enum CashTransactionOrigin {
  AR
  AP
  MANUAL
}

enum CategoryKind {
  INCOME
  EXPENSE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  APPROVE
  CANCEL
}

